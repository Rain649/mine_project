version: '3.8'

services:
  ros_mine:
    # 1️⃣ 构建镜像
    build: 
      context: ..
      dockerfile: docker/Dockerfile
    image: mine_project_image:latest
    container_name: mine_ws_container

    # 2️⃣ 代码同步和持久化
    volumes:
      # 只同步 src 文件夹，避免覆盖 build/install
      - ../src:/mine_ws/src

    # 3️⃣ 网络与通信
    network_mode: "host"   # 只在 Linux 可用
    ipc: "host"
    privileged: true       # 如果需要访问 USB 设备

    # 4️⃣ 容器交互
    tty: true
    stdin_open: true
    restart: unless-stopped

    # 5️⃣ 环境变量
    environment:
      - ROS_DOMAIN_ID=30
      - PYTHONUNBUFFERED=1
      - RCUTILS_COLORIZED_OUTPUT=1

    # 6️⃣ 工作目录
    working_dir: /mine_ws

  # 替换原 entrypoint
    command: >
      /bin/bash -c "
        source /opt/ros/humble/setup.bash &&
        colcon build --symlink-install &&
        source install/setup.bash &&
        exec ros2 run cpp_test talker
      "
    